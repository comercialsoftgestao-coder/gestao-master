<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTÃO MASTER - Administração Imobiliária</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- PDF.js para Visualização de Contratos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <!-- Firebase (Versão Compatibilidade para manter o código intacto) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #fdfdfd; user-select: none; }
        
        .bg-pattern-houses {
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23f59e0b' fill-opacity='0.1'%3E%3Cpath d='M40 10 L55 25 L55 45 L25 45 L25 25 Z' /%3E%3Cpath d='M10 50 L20 60 L20 75 L0 75 L0 60 Z' opacity='0.5'/%3E%3Cpath d='M70 50 L80 60 L80 75 L60 75 L60 60 Z' opacity='0.5'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #001529; }
        ::-webkit-scrollbar-thumb { background: #d97706; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #b45309; }
        
        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(180, 83, 9, 0.1); }

        .print-area { font-family: 'Times New Roman', serif; line-height: 1.6; color: #000; }
        .recibo-box { border: 2px dashed #000; padding: 40px; margin: 20px 0; background: #fff; width: 100%; box-sizing: border-box; }

        @media print {
            body * { visibility: hidden; }
            #print-area-container, #print-area-container * { visibility: visible; }
            #print-area-container { 
                position: fixed; left: 0; top: 0; width: 100%; height: 100%; margin: 0; padding: 40px; 
                background: white !important; z-index: 99999; display: block !important;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-pattern-houses text-slate-700 text-sm">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDW9gF4k0e2XuMbcgKouyIUmo3uaUxLheE",
            authDomain: "gestaomaster-cc7a0.firebaseapp.com",
            projectId: "gestaomaster-cc7a0",
            storageBucket: "gestaomaster-cc7a0.firebasestorage.app",
            messagingSenderId: "61242084578",
            appId: "1:61242084578:web:e1f4fd6a1287bfd3b422bb"
        };

        // Verifica se o Firebase já foi inicializado para evitar erros de reinicialização
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Inicializa o Firestore Database
        const db = firebase.firestore();

        const { useState, useEffect, useMemo, useRef } = React;

        const Toast = ({ message, type, show, onClose }) => {
            if (!show) return null;
            const bgClass = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-amber-600' : 'bg-[#002147]');
            return (
                <div className={`fixed top-4 right-4 ${bgClass} text-white px-4 py-3 rounded-xl shadow-xl z-[60] flex items-center gap-3 animate-fade-in border-2 border-amber-500/20 text-sm`}>
                    <i className={type === 'error' ? "ph ph-warning-circle text-xl" : "ph ph-check-circle text-xl"}></i>
                    <span className="font-semibold">{message}</span>
                    <button onClick={onClose} className="opacity-75 hover:opacity-100 ml-4 transition-opacity"><i className="ph ph-x text-base"></i></button>
                </div>
            );
        };

        const ChartComponent = ({ type, data, options }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    chartRef.current = new Chart(canvasRef.current, { type, data, options: { responsive: true, maintainAspectRatio: false, ...options } });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, options]);
            return <div className="relative h-full w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const BrandLogo = ({ className = "" }) => (
            <div className={`flex items-center gap-3 ${className}`}>
                <div className="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-[#002147] shadow-sm border border-amber-300">
                    <i className="ph-fill ph-house text-2xl"></i>
                </div>
                <div>
                    <h1 className="text-xl font-extrabold tracking-tight text-white drop-shadow-sm leading-none uppercase">GESTÃO<span className="text-amber-500"> MASTER</span></h1>
                    <p className="text-[10px] text-amber-500/80 font-bold uppercase tracking-widest mt-0.5">Adm. de Imóveis</p>
                </div>
            </div>
        );

        const Icon = ({ name, size = 18, className = "", weight = "regular" }) => 
            <i className={`ph ph-${name} ${className}`} style={{ fontSize: size, fontWeight: weight === 'bold' ? 700 : 400 }}></i>;

        const Card = ({ children, className = "", onClick }) => 
            <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-100 ${className}`}>{children}</div>;

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

        const LoginScreen = ({ onLogin }) => {
            const [user, setUser] = useState('');
            const [pass, setPass] = useState('');
            const [remember, setRemember] = useState(false);
            
            useEffect(() => {
                const savedLogin = localStorage.getItem('gestaomaster_remember');
                if (savedLogin) {
                    const { user: savedUser, pass: savedPass } = JSON.parse(savedLogin);
                    setUser(savedUser); setPass(savedPass); setRemember(true);
                }
            }, []);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (remember) localStorage.setItem('gestaomaster_remember', JSON.stringify({ user, pass }));
                else localStorage.removeItem('gestaomaster_remember');
                onLogin(user, pass);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-[#002147] relative overflow-hidden bg-pattern-houses text-sm">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm z-10 border border-amber-500/30 animate-fade-in mx-4">
                        <div className="flex justify-center mb-6">
                            <div className="flex flex-col items-center gap-2">
                                <div className="w-14 h-14 bg-[#002147] rounded-full flex items-center justify-center text-amber-500 shadow-lg border-4 border-amber-500">
                                    <i className="ph-fill ph-house text-3xl"></i>
                                </div>
                                <h1 className="text-2xl font-extrabold text-slate-800 uppercase tracking-tighter">GESTÃO <span className="text-amber-600">MASTER</span></h1>
                            </div>
                        </div>
                        <h2 className="text-xs font-bold text-center text-slate-400 mb-6 uppercase tracking-wider">Acesso Seguro</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="relative">
                                <span className="absolute left-3 top-2.5 text-amber-500"><Icon name="user" weight="bold"/></span>
                                <input type="text" className="w-full p-2.5 pl-10 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-amber-500 focus:bg-white transition-all font-semibold text-slate-600" value={user} onChange={(e) => setUser(e.target.value)} placeholder="Usuário" />
                            </div>
                            <div className="relative">
                                <span className="absolute left-3 top-2.5 text-amber-500"><Icon name="lock" weight="bold"/></span>
                                <input type="password" className="w-full p-2.5 pl-10 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-amber-500 focus:bg-white transition-all font-semibold text-slate-600" value={pass} onChange={(e) => setPass(e.target.value)} placeholder="Senha" />
                            </div>
                            <div className="flex items-center">
                                <input id="remember-me" type="checkbox" className="w-4 h-4 text-[#002147] bg-gray-100 border-gray-300 rounded focus:ring-amber-500" checked={remember} onChange={(e) => setRemember(e.target.checked)} />
                                <label htmlFor="remember-me" className="ml-2 text-xs font-bold text-slate-500 cursor-pointer">Lembrar meus dados</label>
                            </div>
                            <button type="submit" className="w-full bg-gradient-to-r from-[#002147] to-slate-900 hover:from-amber-600 hover:to-amber-700 text-white font-bold py-3 rounded-xl flex justify-center items-center gap-2 shadow-lg shadow-amber-900/20 transform hover:scale-[1.02] transition-all text-sm text-center">
                                ENTRAR NO SISTEMA <Icon name="arrow-right" weight="bold" />
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [appState, setAppState] = useState('login'); 
            const [syncStatus, setSyncStatus] = useState('idle'); 
            const [searchTerm, setSearchTerm] = useState(''); 
            const [situationFilter, setSituationFilter] = useState('all');
            
            const [pageNum, setPageNum] = useState(1);
            const [pageCount, setPageCount] = useState(0);
            const [pdfScale, setPdfScale] = useState(1.5);
            const [pdfDoc, setPdfDoc] = useState(null);

            const [credentials, setCredentials] = useState(() => {
                const saved = localStorage.getItem('gestaomaster_credentials');
                return saved ? JSON.parse(saved) : { user: 'admin', pass: 'admin' };
            });

            const [userData, setUserData] = useState(() => {
                const saved = localStorage.getItem('gestaomaster_userdata');
                return saved ? JSON.parse(saved) : { 
                    name: 'Proprietário Master', 
                    email: 'contato@gestaomaster.pt', 
                    phone: '', 
                    document: '',
                    repasse_day: '10' // Dia padrão de repasse
                };
            });

            const [properties, setProperties] = useState([]);
            const [tenants, setTenants] = useState([]);
            const [contracts, setContracts] = useState([]);
            const [financial, setFinancial] = useState([]);
            const [loading, setLoading] = useState(true);

            const [activeTab, setActiveTab] = useState('dashboard');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalType, setModalType] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            
            const [propertyForm, setPropertyForm] = useState({ 
                nickname: '', address: '', registration_number: '', type: 'Casa', status: 'Vago', base_rent: '', management_fee: '10',
                doc_registration: false, doc_deed: false, doc_iptu: false,
                monthly_condo_cost: '', monthly_iptu_cost: '', monthly_maintenance_avg: '',
                vacant_since: '' // Data de desocupação
            });
            const [tenantForm, setTenantForm] = useState({ name: '', cpf: '', email: '', phone: '', status: 'Ativo', documents_checked: false, propertyId: '' });
            const [contractForm, setContractForm] = useState({ 
                propertyId: '', tenantId: '', start_date: '', end_date: '', rent_value: '', deposit_value: '', payment_day: '5', status: 'Ativo', index_adjustment: 'IPCA', management_fee: '10', fileName: '', fileData: '',
                inspection_entry_name: '', inspection_entry_data: '', inspection_exit_name: '', inspection_exit_data: ''
            });
            const [financeForm, setFinanceForm] = useState({ type: 'Receita', category: 'Aluguel', description: '', value: '', date: '', status: 'Pendente', propertyId: '' });
            const [configPasswordForm, setConfigPasswordForm] = useState({ current: '', newPass: '', confirm: '' });

            const [toast, setToast] = useState({ show: false, message: '', type: 'info' });
            const showToast = (msg, type = 'info') => { setToast({ show: true, message: msg, type }); setTimeout(() => setToast({ show: false, message: '', type: 'info' }), 3000); };

            const maskCPF = (value) => value.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').replace(/(-\d{2})\d+?$/, '$1');
            const maskPhone = (value) => value.replace(/\D/g, "").replace(/^(\d{2})(\d)/g, "($1) $2").replace(/(\d)(\d{4})$/, "$1-$2");

            useEffect(() => {
                if (appState === 'authenticated') {
                    setLoading(true); setSyncStatus('syncing');
                    const loadCollection = async (collectionName, setter) => {
                        try {
                            const snapshot = await db.collection(collectionName).get();
                            setter(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        } catch (error) { showToast(`Erro na nuvem: ${collectionName}`, 'error'); setSyncStatus('error'); }
                    };
                    Promise.all([loadCollection('properties', setProperties), loadCollection('tenants', setTenants), loadCollection('contracts', setContracts), loadCollection('financial', setFinancial)])
                    .then(() => { setLoading(false); setSyncStatus('success'); setTimeout(() => setSyncStatus('idle'), 3000); })
                    .catch(() => { setLoading(false); setSyncStatus('error'); });
                }
            }, [appState]);

            useEffect(() => {
                if (!loading && appState === 'authenticated') {
                    localStorage.setItem('gestaomaster_userdata', JSON.stringify(userData));
                    localStorage.setItem('gestaomaster_credentials', JSON.stringify(credentials));
                }
            }, [userData, credentials, loading, appState]);

            const filteredProperties = useMemo(() => properties.filter(p => p.nickname.toLowerCase().includes(searchTerm.toLowerCase()) || (p.address || '').toLowerCase().includes(searchTerm.toLowerCase())), [properties, searchTerm]);
            const filteredTenants = useMemo(() => tenants.filter(t => t.name.toLowerCase().includes(searchTerm.toLowerCase()) || (t.cpf || '').includes(searchTerm)), [tenants, searchTerm]);
            const filteredContracts = useMemo(() => contracts.filter(c => {
                const p = properties.find(i => i.id === c.propertyId);
                const t = tenants.find(i => i.id === c.tenantId);
                return (p?.nickname || '').toLowerCase().includes(searchTerm.toLowerCase()) || (t?.name || '').toLowerCase().includes(searchTerm.toLowerCase());
            }), [contracts, properties, tenants, searchTerm]);
            const filteredFinancial = useMemo(() => financial.filter(f => f.description.toLowerCase().includes(searchTerm.toLowerCase())), [financial, searchTerm]);

            const filteredSituationProperties = useMemo(() => {
                if (situationFilter === 'pending') return properties.filter(p => !p.doc_registration || !p.doc_deed || !p.doc_iptu);
                if (situationFilter === 'ok') return properties.filter(p => p.doc_registration && p.doc_deed && p.doc_iptu);
                return properties;
            }, [properties, situationFilter]);

            // --- LÓGICA DE ALARMES MASTER ---
            const activeAlarms = useMemo(() => {
                const alarms = [];
                const today = new Date();
                
                // 1. Alarme de Repasse
                if (today.getDate() === parseInt(userData.repasse_day)) {
                    alarms.push({ type: 'warning', icon: 'money', title: 'DIA DE REPASSE', desc: 'Hoje é o dia programado para o repasse da imobiliária. Verifique sua conta!' });
                }

                // 2. Alarme de Vacância (30 dias)
                properties.forEach(p => {
                    if (p.status === 'Vago' && p.vacant_since) {
                        const vDate = new Date(p.vacant_since);
                        const diffTime = Math.abs(today - vDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays >= 30) {
                            alarms.push({ type: 'error', icon: 'house-line', title: `VACÂNCIA CRÍTICA: ${p.nickname}`, desc: `Imóvel ocioso há ${diffDays} dias. Custo fixo acumulando.` });
                        }
                    }
                });

                // 3. Alarme de Contrato Ausente (Propriedade Alugada mas sem arquivo)
                properties.forEach(p => {
                    if (p.status === 'Alugado') {
                        const hasContractFile = contracts.some(c => c.propertyId === p.id && c.fileData);
                        if (!hasContractFile) {
                            alarms.push({ type: 'warning', icon: 'file-x', title: `CONTRATO NÃO RECEBIDO: ${p.nickname}`, desc: `Imóvel marcado como alugado, mas a imobiliária não enviou o arquivo PDF.` });
                        }
                    }
                });

                // 4. Alarme de Vencimento de Contrato (Próximos 60 dias)
                contracts.forEach(c => {
                    if (c.status === 'Ativo' && c.end_date) {
                        const eDate = new Date(c.end_date);
                        const diffTime = eDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays > 0 && diffDays <= 60) {
                            const p = properties.find(i => i.id === c.propertyId);
                            alarms.push({ type: 'info', icon: 'clock-afternoon', title: `VENCIMENTO PRÓXIMO: ${p?.nickname}`, desc: `O contrato vence em ${diffDays} dias. Inicie a renovação.` });
                        }
                    }
                });

                return alarms;
            }, [properties, contracts, userData.repasse_day]);

            const stats = useMemo(() => {
                const totalIncome = financial.filter(f => f.type === 'Receita' && f.status === 'Pago').reduce((a, b) => a + (b.value || 0), 0);
                const totalExpense = financial.filter(f => f.type === 'Despesa' && f.status === 'Pago').reduce((a, b) => a + (b.value || 0), 0);
                const activeContracts = contracts.filter(c => c.status === 'Ativo');
                const grossRent = activeContracts.reduce((a, b) => a + (b.rent_value || 0), 0);
                const totalFees = activeContracts.reduce((a, b) => a + ((b.rent_value || 0) * ((b.management_fee || 0) / 100)), 0);
                const propertiesOk = properties.filter(p => p.doc_registration && p.doc_deed && p.doc_iptu).length;
                
                const vacantProperties = properties.filter(p => p.status === 'Vago');
                const vacancyLoss = vacantProperties.reduce((acc, p) => acc + (Number(p.monthly_condo_cost) || 0) + (Number(p.monthly_iptu_cost) || 0) + (Number(p.monthly_maintenance_avg) || 0), 0);
                const opportunityCost = vacantProperties.reduce((acc, p) => acc + (Number(p.base_rent) || 0), 0);

                return { 
                    totalIncome, totalExpense, occupied: properties.filter(p => p.status === 'Alugado').length, 
                    activeValue: grossRent, totalFees, netTransferExpected: grossRent - totalFees, 
                    pendingDocs: properties.length - propertiesOk, totalProperties: properties.length, okDocs: propertiesOk,
                    vacancyLoss, opportunityCost
                };
            }, [financial, properties, contracts]);

            const chartFinancialData = useMemo(() => ({ labels: ['Receitas', 'Despesas'], datasets: [{ label: 'R$', data: [stats.totalIncome, stats.totalExpense], backgroundColor: ['#d97706', '#ef4444'], borderRadius: 6, barThickness: 40 }] }), [stats]);
            const chartOccupancyData = useMemo(() => ({ labels: ['Alugado', 'Vago', 'Outros'], datasets: [{ data: [stats.occupied, stats.totalProperties - stats.occupied, 0], backgroundColor: ['#002147', '#d97706', '#94a3b8'], borderWidth: 0, hoverOffset: 4 }] }), [stats]);
            const chartVacancyData = useMemo(() => ({ labels: ['Custo Operacional (IPTU/Cond)', 'Aluguel Não Recebido'], datasets: [{ data: [stats.vacancyLoss, stats.opportunityCost], backgroundColor: ['#ef4444', '#f59e0b'], borderWidth: 0, hoverOffset: 4 }] }), [stats]);

            const handleLogin = (u, p) => {
                if (u === credentials.user && p === credentials.pass) setAppState('authenticated');
                else showToast('Dados de acesso incorretos', 'error');
            };

            const saveToCloud = async (collectionName, itemData, setter, currentList, isEdit) => {
                setSyncStatus('syncing'); const docId = String(itemData.id);
                try {
                    await db.collection(collectionName).doc(docId).set(itemData);
                    setter(isEdit ? currentList.map(i => String(i.id) === docId ? itemData : i) : [...currentList, itemData]);
                    setSyncStatus('success'); showToast('Salvo com Sucesso!', 'success'); setIsModalOpen(false);
                } catch (error) { showToast('Erro ao salvar.', 'error'); setSyncStatus('error'); }
            };

            const deleteFromCloud = async (collectionName, id, setter, currentList) => {
                if(!confirm('Deseja eliminar este registro permanentemente?')) return;
                setSyncStatus('syncing');
                try { await db.collection(collectionName).doc(String(id)).delete(); setter(currentList.filter(i => String(i.id) !== String(id))); setSyncStatus('success'); showToast('Removido.', 'success'); }
                catch (error) { setSyncStatus('error'); }
            };

            const generateReportDOC = (type) => {
                let title = ""; let tableHeader = ""; let tableRows = "";
                if (type === 'report_finance') {
                    title = "Fluxo Financeiro Realizado";
                    tableHeader = `<tr style="background-color:#f3f4f6;"><th>Data</th><th>Descrição</th><th>Valor</th><th>Status</th></tr>`;
                    tableRows = financial.map(f => `<tr><td>${new Date(f.date).toLocaleDateString()}</td><td>${f.description}</td><td>${formatCurrency(f.value)}</td><td>${f.status}</td></tr>`).join('');
                } else if (type === 'report_performance') {
                    title = "Performance de Repasse e Ativos";
                    tableHeader = `<tr style="background-color:#f3f4f6;"><th>Ativo</th><th>Matrícula</th><th>Aluguel Bruto</th><th>Taxa Adm (%)</th><th>Repasse Líquido</th></tr>`;
                    tableRows = contracts.filter(c=>c.status==='Ativo').map(c => {
                        const p = properties.find(i=>i.id==c.propertyId);
                        const fee = (c.rent_value || 0) * ((c.management_fee || 0)/100);
                        return `<tr><td>${p?.nickname || '-'}</td><td>${p?.registration_number || '-'}</td><td>${formatCurrency(c.rent_value)}</td><td>${c.management_fee}%</td><td>${formatCurrency(c.rent_value - fee)}</td></tr>`;
                    }).join('');
                } else if (type === 'report_docs') {
                    title = "Auditoria de Documentação Patrimonial";
                    tableHeader = `<tr style="background-color:#f3f4f6;"><th>Imóvel</th><th>Matrícula</th><th>Matrícula OK</th><th>Escritura OK</th><th>IPTU OK</th></tr>`;
                    tableRows = properties.map(p => `<tr><td>${p.nickname}</td><td>${p.registration_number || '-'}</td><td>${p.doc_registration?'SIM':'NÃO'}</td><td>${p.doc_deed?'SIM':'NÃO'}</td><td>${p.doc_iptu?'SIM':'NÃO'}</td></tr>`).join('');
                } else {
                    title = "Listagem de Locatários";
                    tableHeader = `<tr style="background-color:#f3f4f6;"><th>Nome</th><th>CPF/NIF</th><th>Telefone</th><th>Status</th></tr>`;
                    tableRows = tenants.map(t => `<tr><td>${t.name}</td><td>${t.cpf}</td><td>${t.phone}</td><td>${t.status}</td></tr>`).join('');
                }
                const content = `<html><head><meta charset='utf-8'><title>${title}</title><style>body { font-family: 'Calibri', sans-serif; } h1 { color: #002147; text-align: center; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th, td { border: 1px solid #000; padding: 8px; text-align: left; } th { background-color: #f3f4f6; }</style></head><body><h1>GESTÃO MASTER - ${title}</h1><p>Emitido em: ${new Date().toLocaleString()}</p><table><thead>${tableHeader}</thead><tbody>${tableRows}</tbody></table></body></html>`;
                const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([content], { type: 'application/msword' })); link.download = `Relatorio_Master_${type}.doc`; link.click();
                showToast('Relatório gerado!', 'success');
            };

            const openModal = (type, item = null) => {
                setModalType(type); setEditingItem(item);
                const today = new Date().toISOString().split('T')[0];
                setPageNum(1); setPdfScale(1.5); 
                if (type === 'property') setPropertyForm(item || { nickname: '', address: '', registration_number: '', type: 'Casa', status: 'Vago', base_rent: '', management_fee: '10', doc_registration: false, doc_deed: false, doc_iptu: false, monthly_condo_cost: '', monthly_iptu_cost: '', monthly_maintenance_avg: '', vacant_since: '' });
                else if (type === 'tenant') setTenantForm(item || { name: '', cpf: '', email: '', phone: '', status: 'Ativo', documents_checked: false, propertyId: '' });
                else if (type === 'contract') setContractForm(item || { propertyId: '', tenantId: '', start_date: today, end_date: '', rent_value: '', deposit_value: '', payment_day: '5', status: 'Ativo', index_adjustment: 'IPCA', management_fee: '10', fileName: '', fileData: '', inspection_entry_name: '', inspection_entry_data: '', inspection_exit_name: '', inspection_exit_data: '' });
                else if (type === 'finance') setFinanceForm(item || { type: 'Receita', category: 'Aluguel', description: '', value: '', date: today, status: 'Pendente', propertyId: '' });
                setIsModalOpen(true);
            };

            const handleSaveConfig = (e) => {
                e.preventDefault();
                showToast('Perfil master atualizado!', 'success');
            };

            const handleChangePassword = (e) => {
                e.preventDefault();
                if (configPasswordForm.newPass !== configPasswordForm.confirm) {
                    showToast('As senhas não coincidem!', 'error');
                    return;
                }
                setCredentials({ ...credentials, pass: configPasswordForm.newPass });
                setConfigPasswordForm({ current: '', newPass: '', confirm: '' });
                showToast('Senha master atualizada!', 'success');
            };

            const saveItem = (e) => {
                e.preventDefault();
                const id = editingItem ? editingItem.id : Date.now();
                const isEdit = !!editingItem;
                if (modalType === 'property') saveToCloud('properties', { ...propertyForm, id, base_rent: parseFloat(propertyForm.base_rent), management_fee: parseFloat(propertyForm.management_fee) }, setProperties, properties, isEdit);
                else if (modalType === 'tenant') saveToCloud('tenants', { ...tenantForm, id }, setTenants, tenants, isEdit);
                else if (modalType === 'contract') saveToCloud('contracts', { ...contractForm, id, rent_value: parseFloat(contractForm.rent_value), management_fee: parseFloat(contractForm.management_fee), propertyId: parseInt(contractForm.propertyId), tenantId: parseInt(contractForm.tenantId) }, setContracts, contracts, isEdit);
                else if (modalType === 'finance') saveToCloud('financial', { ...financeForm, id, value: parseFloat(financeForm.value), propertyId: parseInt(financeForm.propertyId) }, setFinancial, financial, isEdit);
            };

            const renderPage = async (pdf, num, scale) => {
                try {
                    const page = await pdf.getPage(num);
                    const viewport = page.getViewport({ scale });
                    const canvas = document.getElementById('pdf-canvas');
                    if (!canvas) return;
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport }).promise;
                } catch (err) {}
            };

            useEffect(() => {
                if (modalType === 'contract_view' && editingItem?.fileData?.includes('pdf')) {
                    pdfjsLib.getDocument(editingItem.fileData).promise.then(pdf => {
                        setPdfDoc(pdf);
                        setPageCount(pdf.numPages);
                    });
                }
            }, [modalType, editingItem]);

            useEffect(() => { if (pdfDoc) renderPage(pdfDoc, pageNum, pdfScale); }, [pdfDoc, pageNum, pdfScale]);

            const menuItems = [
                { id: 'dashboard', label: 'Visão Geral', icon: 'chart-pie-slice' },
                { id: 'properties', label: 'Meus Imóveis', icon: 'house' },
                { id: 'tenants', label: 'Inquilinos', icon: 'users' },
                { id: 'contracts', label: 'Contratos', icon: 'file-text' },
                { id: 'finance', label: 'Financeiro', icon: 'currency-dollar' },
                { id: 'reports', label: 'Relatórios', icon: 'scroll' },
                { id: 'situation', label: 'Situação Legal', icon: 'gavel' },
                { id: 'config', label: 'Configurações', icon: 'gear' }, 
            ];

            if (appState === 'login') return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className="flex h-screen overflow-hidden bg-pattern-houses text-slate-700 font-bold text-sm text-left">
                    <Toast {...toast} onClose={() => setToast({...toast, show: false})} />
                    
                    <aside className={`fixed inset-y-0 left-0 z-30 w-64 bg-[#002147] text-white flex flex-col transition-transform duration-300 md:relative md:translate-x-0 ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} shadow-2xl border-r border-amber-500/20`}>
                        <div className="p-6 border-b border-amber-500/10"><BrandLogo /></div>
                        <nav className="flex-1 overflow-y-auto py-6 px-4 space-y-1.5">
                            {menuItems.map(item => (
                                <button key={item.id} onClick={() => { setActiveTab(item.id); setIsMobileMenuOpen(false); }}
                                    className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl transition-all font-bold text-sm ${activeTab === item.id ? 'bg-amber-500 text-[#002147] shadow-lg translate-x-1' : 'hover:bg-amber-600/10 hover:text-amber-500 hover:translate-x-1 text-white/90'}`}>
                                    <Icon name={item.icon} size={20} weight={activeTab === item.id ? 'fill' : 'bold'} />
                                    {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-6 bg-[#001a38]">
                            <div className="flex items-center gap-3">
                                <div className="w-9 h-9 bg-amber-500 rounded-full flex items-center justify-center font-bold text-[#002147] text-xs border-2 border-amber-600 uppercase">{userData.name.charAt(0)}</div>
                                <div className="flex-1 min-w-0"><p className="text-xs font-bold text-white truncate">{userData.name}</p><p className="text-[10px] text-amber-500 uppercase tracking-wide truncate">Proprietário Master</p></div>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0 overflow-hidden relative">
                        <header className="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-4 md:px-8 shadow-sm z-10 shrink-0">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="md:hidden text-[#002147] p-2 hover:bg-slate-100 rounded-lg"><Icon name="list" size={24} /></button>
                                <div><h2 className="text-xl font-extrabold text-slate-800 tracking-tight uppercase">{menuItems.find(i => i.id === activeTab)?.label}</h2></div>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest ${syncStatus === 'syncing' ? 'bg-amber-100 text-amber-700' : 'bg-[#002147] text-amber-500'}`}>
                                    {syncStatus === 'syncing' ? <Icon name="spinner" className="animate-spin"/> : <Icon name="cloud-check" weight="fill"/>}
                                    <span className="hidden md:inline">{syncStatus === 'syncing' ? 'Sincronizando...' : 'Nuvem Master OK'}</span>
                                </div>
                                <button onClick={() => setAppState('login')} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:text-red-500 transition-colors"><Icon name="sign-out" size={18} weight="bold"/></button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in text-left">
                                    {/* --- CENTRAL DE ALARMES MASTER (BLOCO DE DETALHES) --- */}
                                    {activeAlarms.length > 0 && (
                                        <div className="bg-white p-6 rounded-3xl border border-red-100 shadow-xl space-y-4 mb-6">
                                            <div className="flex items-center justify-between border-b border-red-50 pb-4">
                                                <h4 className="text-sm font-black uppercase tracking-widest text-red-600 flex items-center gap-2">
                                                    <Icon name="warning-circle" weight="fill"/> Alarmes de Auditoria Master
                                                </h4>
                                                <span className="bg-red-100 text-red-700 px-3 py-1 rounded-full text-[10px] font-black">{activeAlarms.length} ALERTA(S)</span>
                                            </div>
                                            <div className="space-y-3">
                                                {activeAlarms.map((alarm, idx) => (
                                                    <div key={idx} className={`p-4 rounded-2xl border-l-4 flex items-center gap-4 transition-all hover:translate-x-1 ${alarm.type === 'error' ? 'bg-red-50 border-red-500 text-red-700' : (alarm.type === 'warning' ? 'bg-amber-50 border-amber-500 text-amber-700' : 'bg-blue-50 border-blue-500 text-blue-700')}`}>
                                                        <div className={`p-2 rounded-xl shrink-0 ${alarm.type === 'error' ? 'bg-red-100' : (alarm.type === 'warning' ? 'bg-amber-100' : 'bg-blue-100')}`}>
                                                            <Icon name={alarm.icon} weight="bold" size={20}/>
                                                        </div>
                                                        <div>
                                                            <p className="text-xs font-black uppercase tracking-tighter">{alarm.title}</p>
                                                            <p className="text-[11px] font-bold opacity-80 leading-tight">{alarm.desc}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="bg-gradient-to-r from-[#002147] to-[#003366] p-1 rounded-3xl shadow-xl overflow-hidden mb-6">
                                        <div className="bg-white/5 backdrop-blur-sm p-6 rounded-[1.4rem] flex flex-col md:flex-row items-center justify-between gap-6">
                                            <div className="text-white">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <div className="p-1.5 bg-amber-500 rounded-lg text-[#002147]"><Icon name="trend-up" weight="bold"/></div>
                                                    <p className="text-[10px] font-black uppercase tracking-widest text-amber-500">Performance Master de Repasse (Previsão Mensal)</p>
                                                </div>
                                                <h3 className="text-3xl font-black tracking-tighter">O seu Repasse Líquido: <span className="text-amber-500">{formatCurrency(stats.netTransferExpected)}</span></h3>
                                                <p className="text-xs font-bold text-white/60 mt-1">Baseado em {contracts.filter(c=>c.status==='Ativo').length} ativos auditados.</p>
                                            </div>
                                            <div className="flex gap-4 w-full md:w-auto">
                                                <div className="bg-white/10 px-4 py-3 rounded-2xl border border-white/10 flex-1 text-center">
                                                    <p className="text-[9px] font-black uppercase text-amber-500 text-center">Renda Bruta</p>
                                                    <p className="text-lg font-bold text-white text-center">{formatCurrency(stats.activeValue)}</p>
                                                </div>
                                                <div className="bg-red-500/10 px-4 py-3 rounded-2xl border border-red-500/20 flex-1 text-center">
                                                    <p className="text-[9px] font-black uppercase text-red-400 text-center">Taxa Imobiliária</p>
                                                    <p className="text-lg font-bold text-red-400 text-center">- {formatCurrency(stats.totalFees)}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* --- GRADE DE BLOQUINHOS DE ESTATÍSTICA --- */}
                                    <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                        <Card className="p-5 bg-white border border-slate-100 card-hover text-left">
                                            <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-2">Ocupação Atual</p>
                                            <h3 className="text-2xl font-extrabold text-slate-800 text-left">{stats.occupied} / {stats.totalProperties}</h3>
                                        </Card>
                                        <Card className="p-5 bg-white border border-slate-100 card-hover text-left" onClick={() => setActiveTab('situation')}>
                                            <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-2">Docs Pendentes</p>
                                            <h3 className="text-2xl font-extrabold text-amber-600 text-left">{stats.pendingDocs}</h3>
                                        </Card>
                                        
                                        {/* NOVO BLOQUINHO: ALARMES ATIVOS */}
                                        <Card className={`p-5 bg-white border-2 card-hover text-left shadow-md ${activeAlarms.length > 0 ? 'border-red-200 bg-red-50/20' : 'border-slate-100'}`}>
                                            <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-2 flex items-center gap-2">
                                                <Icon name="bell-ringing" weight={activeAlarms.length > 0 ? "fill" : "regular"} className={activeAlarms.length > 0 ? "text-red-500" : ""}/> Alertas Ativos
                                            </p>
                                            <h3 className={`text-2xl font-black text-left ${activeAlarms.length > 0 ? 'text-red-600' : 'text-slate-800'}`}>{activeAlarms.length}</h3>
                                        </Card>

                                        <Card className="p-5 bg-white border-2 border-red-100 bg-red-50/30 card-hover text-left shadow-lg">
                                            <p className="text-[10px] text-red-500 uppercase font-extrabold tracking-wider mb-2 flex items-center gap-2">
                                                <Icon name="trend-down" weight="bold"/> Perda por Ócio
                                            </p>
                                            <h3 className="text-2xl font-black text-red-600 text-left">{formatCurrency(stats.vacancyLoss + stats.opportunityCost)}</h3>
                                        </Card>
                                        <Card className="p-5 bg-white border border-slate-100 card-hover text-left">
                                            <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-2">Manutenção</p>
                                            <h3 className="text-2xl font-extrabold text-red-500 text-left">{formatCurrency(stats.totalExpense)}</h3>
                                        </Card>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <Card className="p-6 lg:col-span-1 card-hover bg-white border border-slate-100">
                                            <h3 className="font-bold text-lg text-red-600 mb-6 flex items-center gap-2"><Icon name="chart-pie-slice" weight="fill" className="text-red-600"/> Prejuízo de Ociosidade</h3>
                                            <div className="h-64"><ChartComponent type="doughnut" data={chartVacancyData} options={{ maintainAspectRatio: false }} /></div>
                                        </Card>
                                        <Card className="p-6 lg:col-span-2 card-hover bg-white border border-slate-100">
                                            <h3 className="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2"><Icon name="chart-bar" weight="fill" className="text-amber-600"/> Fluxo de Caixa Realizado</h3>
                                            <div className="h-64"><ChartComponent type="bar" data={chartFinancialData} options={{ maintainAspectRatio: false, plugins: { legend: { display: false } } }} /></div>
                                        </Card>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'reports' && (
                                <div className="space-y-8 animate-fade-in text-left">
                                    <div className="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm text-center">
                                        <div className="w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center mx-auto text-amber-600 mb-4"><Icon name="scroll" size={32} weight="duotone"/></div>
                                        <h2 className="text-2xl font-black text-slate-800 uppercase tracking-tighter">Painel Master de Auditoria</h2>
                                        <p className="text-slate-500 font-bold max-w-md mx-auto mt-2">Gere relatórios detalhados para fiscalizar a atuação da imobiliária e garantir a saúde do seu patrimônio.</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        {[
                                            { id: 'performance', title: 'Performance de Repasse', icon: 'trend-up', desc: 'Auditoria de renda bruta vs líquida após taxas de adm.', color: 'amber' },
                                            { id: 'docs', title: 'Auditoria Documental', icon: 'folder-lock', desc: 'Status de matrículas, escrituras e IPTU dos ativos.', color: 'blue' },
                                            { id: 'finance', title: 'Fluxo Financeiro', icon: 'currency-dollar', desc: 'Lançamentos detalhados de receitas e despesas do mês.', color: 'green' },
                                            { id: 'tenants', title: 'Listagem de Ocupantes', icon: 'users', desc: 'Dados consolidados de todos os locatários ativos.', color: 'slate' }
                                        ].map(rep => (
                                            <Card key={rep.id} className="p-6 card-hover border-none shadow-md flex flex-col justify-between group">
                                                <div className="text-left">
                                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center mb-4 transition-transform group-hover:scale-110 ${rep.color === 'amber' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-[#002147]'}`}><Icon name={rep.icon} size={24} weight="fill"/></div>
                                                    <h3 className="font-black text-lg text-slate-800 uppercase tracking-tighter mb-2">{rep.title}</h3>
                                                    <p className="text-xs font-bold text-slate-400 mb-6">{rep.desc}</p>
                                                </div>
                                                <button onClick={() => generateReportDOC(rep.id)} className="w-full py-3 bg-[#002147] text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-amber-600 transition-colors flex items-center justify-center gap-2 text-center">
                                                    <Icon name="download-simple" weight="bold"/> Baixar (.doc)
                                                </button>
                                            </Card>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'situation' && (
                                <div className="space-y-8 animate-fade-in text-left">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <Card className={`p-6 border-l-4 shadow-sm bg-white cursor-pointer transition-all ${situationFilter === 'pending' ? 'border-amber-600 scale-105' : 'border-amber-500'}`} onClick={() => setSituationFilter('pending')}>
                                            <div className="flex justify-between items-center"><div><p className="text-[10px] font-black uppercase text-slate-400 tracking-widest text-left">Auditados com Pendência</p><h4 className="text-3xl font-black text-[#002147] text-left">{stats.pendingDocs}</h4></div><Icon name="warning-diamond" size={40} className="text-amber-500" weight="fill"/></div>
                                        </Card>
                                        <Card className={`p-6 border-l-4 shadow-sm bg-white cursor-pointer transition-all ${situationFilter === 'ok' ? 'border-blue-600 scale-105' : 'border-blue-500'}`} onClick={() => setSituationFilter('ok')}>
                                            <div className="flex justify-between items-center"><div><p className="text-[10px] font-black uppercase text-slate-400 tracking-widest text-left">Documentação 100% OK</p><h4 className="text-3xl font-black text-[#002147] text-left">{stats.okDocs}</h4></div><Icon name="check-circle" size={40} className="text-blue-500" weight="fill"/></div>
                                        </Card>
                                        <Card className={`p-6 border-l-4 shadow-sm bg-white cursor-pointer transition-all ${situationFilter === 'all' ? 'border-[#002147] scale-105' : 'border-slate-300'}`} onClick={() => setSituationFilter('all')}>
                                            <div className="flex justify-between items-center"><div><p className="text-[10px] font-black uppercase text-slate-400 tracking-widest text-left">Total de Ativos Auditados</p><h4 className="text-3xl font-black text-[#002147] text-left">{stats.totalProperties}</h4></div><Icon name="shield-check" size={40} className="text-[#002147]" weight="fill"/></div>
                                        </Card>
                                    </div>
                                    <Card className="overflow-hidden border-none shadow-md">
                                        <div className="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                                            <h3 className="font-black text-[#002147] uppercase tracking-tighter flex items-center gap-2"><Icon name="list-checks" weight="bold" className="text-amber-600"/> Tabela de Auditoria de Patrimônio</h3>
                                            <div className="flex gap-2 bg-white p-1 rounded-xl border border-slate-100 shadow-sm">
                                                <button onClick={() => setSituationFilter('all')} className={`px-4 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all ${situationFilter === 'all' ? 'bg-[#002147] text-amber-500 shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>Todos</button>
                                                <button onClick={() => setSituationFilter('pending')} className={`px-4 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all ${situationFilter === 'pending' ? 'bg-amber-100 text-amber-700 shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>Pendentes</button>
                                                <button onClick={() => setSituationFilter('ok')} className={`px-4 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all ${situationFilter === 'ok' ? 'bg-blue-100 text-blue-700 shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>Regularizados</button>
                                            </div>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-xs text-left font-bold min-w-[800px]">
                                                <thead className="bg-white text-slate-400 uppercase font-extrabold text-[10px] border-b text-left">
                                                    <tr><th className="p-4">Imóvel</th><th className="p-4">Matrícula</th><th className="p-4 text-center">Docs Matrícula</th><th className="p-4 text-center">Escritura</th><th className="p-4 text-center">IPTU</th><th className="p-4 text-center">Status Final</th><th className="p-4 text-center">Ação</th></tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-50 bg-white text-left">
                                                    {filteredSituationProperties.map(p => {
                                                        const isOk = p.doc_registration && p.doc_deed && p.doc_iptu;
                                                        return (
                                                            <tr key={p.id} className={`hover:bg-slate-50/50 transition-colors ${!isOk ? 'bg-amber-50/20' : ''}`}>
                                                                <td className="p-4"><p className="text-[#002147] font-black uppercase tracking-tighter text-left">{p.nickname}</p><p className="text-[9px] text-slate-400 italic truncate max-w-[200px] text-left">{p.address}</p></td>
                                                                <td className="p-4 text-slate-500 text-left">{p.registration_number || '---'}</td>
                                                                <td className="p-4 text-center">{p.doc_registration ? <Icon name="check-circle" className="text-blue-500" weight="fill" size={18}/> : <Icon name="warning-circle" className="text-amber-500" weight="fill" size={18}/>}</td>
                                                                <td className="p-4 text-center">{p.doc_deed ? <Icon name="check-circle" className="text-blue-500" weight="fill" size={18}/> : <Icon name="warning-circle" className="text-amber-500" weight="fill" size={18}/>}</td>
                                                                <td className="p-4 text-center">{p.doc_iptu ? <Icon name="check-circle" className="text-blue-500" weight="fill" size={18}/> : <Icon name="warning-circle" className="text-amber-500" weight="fill" size={18}/>}</td>
                                                                <td className="p-4 text-center"><span className={`px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-widest ${isOk ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'}`}>{isOk ? 'REGULARIZADO' : 'PENDENTE'}</span></td>
                                                                <td className="p-4 text-center"><button onClick={() => openModal('property', p)} className="p-2 bg-slate-100 text-[#002147] rounded-lg hover:bg-[#002147] hover:text-white transition-all"><Icon name="pencil-simple" weight="bold"/></button></td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </Card>
                                </div>
                            )}

                            {activeTab === 'properties' && (
                                <div className="space-y-6 animate-fade-in text-left">
                                    <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                        <h2 className="text-lg font-extrabold uppercase text-left">Gestão de Ativos</h2>
                                        <button onClick={() => openModal('property')} className="bg-[#002147] text-amber-500 px-5 py-2.5 rounded-xl text-xs font-extrabold flex items-center gap-2 shadow-lg"><Icon name="plus" weight="bold"/> NOVO IMÓVEL</button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {filteredProperties.map(p => (
                                            <Card key={p.id} className="overflow-hidden group card-hover border-none shadow-md text-left">
                                                <div className={`h-2 w-full ${p.status === 'Alugado' ? 'bg-[#002147]' : (p.status === 'Vago' ? 'bg-amber-600' : 'bg-red-500')}`}></div>
                                                <div className="p-5 text-left">
                                                    <div className="flex justify-between items-start mb-1 text-left">
                                                        <h3 className="font-extrabold text-lg text-slate-800 text-left">{p.nickname}</h3>
                                                        <span className="px-2 py-0.5 rounded-md text-[10px] font-black uppercase tracking-wider bg-slate-100 text-slate-800">{p.status}</span>
                                                    </div>
                                                    <p className="text-xs font-bold text-slate-500 mb-2 text-left">{p.address || 'Endereço não informado'}</p>
                                                    <p className="text-[10px] font-black text-[#002147] opacity-60 uppercase mb-4 text-left">Matrícula: {p.registration_number || '-'}</p>
                                                    <div className="flex justify-between items-center border-t border-slate-50 pt-3">
                                                        <div className="text-left"><p className="text-[10px] font-black text-slate-400 uppercase text-left">Valor Aluguel</p><span className="font-extrabold text-lg text-left">{formatCurrency(p.base_rent)}</span></div>
                                                        <div className="flex gap-1"><button onClick={() => openModal('property', p)} className="p-2 text-amber-600 hover:bg-amber-50 rounded-lg"><Icon name="pencil-simple" weight="bold" size={16}/></button><button onClick={() => deleteFromCloud('properties', p.id, setProperties, properties)} className="p-2 text-red-600 hover:bg-red-50 rounded-lg"><Icon name="trash" weight="bold" size={16}/></button></div>
                                                    </div>
                                                </div>
                                            </Card>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'tenants' && (
                                <div className="space-y-6 animate-fade-in text-left">
                                    <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                        <h2 className="text-lg font-extrabold uppercase text-left">Base de Locatários</h2>
                                        <button onClick={() => openModal('tenant')} className="bg-amber-600 text-white px-5 py-2.5 rounded-xl text-xs font-extrabold flex items-center gap-2 shadow-lg"><Icon name="plus" weight="bold"/> NOVO INQUILINO</button>
                                    </div>
                                    <Card className="p-0 overflow-x-auto border-none shadow-md">
                                        <table className="w-full text-xs text-left font-bold min-w-[600px]">
                                            <thead className="bg-slate-50 text-slate-400 uppercase font-extrabold text-[10px] border-b border-slate-100 text-left">
                                                <tr><th className="p-4">Nome</th><th className="p-4">CPF/NIF</th><th className="p-4 text-center">Status</th><th className="p-4 text-center">Ações</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50 text-left">
                                                {filteredTenants.map(t => (
                                                    <tr key={t.id} className="hover:bg-slate-50 text-left"><td className="p-4 text-left">{t.name}</td><td className="p-4 text-left">{t.cpf}</td><td className="p-4 text-center"><span className="px-3 py-1 rounded-full text-[10px] uppercase font-extrabold bg-amber-100 text-amber-700">{t.status}</span></td><td className="p-4 flex justify-center gap-3"><button onClick={() => openModal('tenant', t)} className="text-amber-600"><Icon name="pencil-simple" weight="bold" size={18}/></button><button onClick={() => deleteFromCloud('tenants', t.id, setTenants, tenants)} className="text-red-400"><Icon name="trash" weight="bold" size={18}/></button></td></tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </Card>
                                </div>
                            )}

                            {activeTab === 'contracts' && (
                                <div className="space-y-6 animate-fade-in text-left">
                                    <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 text-left">
                                        <h2 className="text-lg font-extrabold uppercase text-left">Contratos & Auditoria</h2>
                                        <button onClick={() => openModal('contract')} className="bg-[#002147] text-amber-500 px-5 py-2.5 rounded-xl text-xs font-extrabold flex items-center gap-2 shadow-lg text-center">UPLOAD CONTRATO</button>
                                    </div>
                                    <div className="space-y-3 text-left">
                                        {filteredContracts.map(c => {
                                            const prop = properties.find(p => p.id === c.propertyId);
                                            const tenant = tenants.find(t => t.id === c.tenantId);
                                            return (
                                                <Card key={c.id} className="p-5 flex flex-col md:flex-row justify-between items-center gap-6 border-l-4 border-l-[#002147] shadow-md text-left">
                                                    <div className="flex items-center gap-4 flex-1 text-left">
                                                        <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center font-bold text-lg"><Icon name="file-pdf" weight="fill"/></div>
                                                        <div className="text-left">
                                                            <h3 className="font-extrabold text-base text-slate-800 uppercase text-left">{prop?.nickname || 'Ativo Auditado'}</h3>
                                                            <p className="text-xs font-bold text-slate-500 text-left">Locatário: {tenant?.name || 'Não identificado'}</p>
                                                            <div className="flex gap-2 mt-2">
                                                                <span className={`px-2 py-0.5 rounded-md text-[8px] font-black uppercase tracking-widest ${c.inspection_entry_data ? 'bg-blue-100 text-blue-700' : 'bg-red-50 text-red-400'}`}>Vistoria Entrada: {c.inspection_entry_data ? 'OK' : 'FALTA'}</span>
                                                                <span className={`px-2 py-0.5 rounded-md text-[8px] font-black uppercase tracking-widest ${c.inspection_exit_data ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-400'}`}>Vistoria Saída: {c.inspection_exit_data ? 'OK' : '--'}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-8 text-left">
                                                        <div className="text-right text-left"><p className="text-[10px] text-slate-400 uppercase font-extrabold text-left">Taxa de Adm.</p><p className="text-sm font-black text-amber-600 text-left">{c.management_fee || 0}%</p></div>
                                                        <div className="text-right text-left"><p className="text-[10px] text-slate-400 uppercase font-extrabold text-left">Aluguel Bruto</p><p className="text-xl font-black text-slate-800 text-left">{formatCurrency(c.rent_value)}</p></div>
                                                        <div className="flex gap-2"><button onClick={() => openModal('contract_view', c)} className="p-2.5 bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-600 hover:text-white transition-all"><Icon name="eye" weight="bold" size={18}/></button><button onClick={() => openModal('contract', c)} className="p-2.5 bg-slate-100 rounded-xl"><Icon name="pencil-simple" weight="bold" size={18}/></button><button onClick={() => deleteFromCloud('contracts', c.id, setContracts, contracts)} className="p-2.5 text-red-400 hover:bg-red-50 rounded-xl"><Icon name="trash" weight="bold" size={18}/></button></div>
                                                    </div>
                                                </Card>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'finance' && (
                                <div className="space-y-6 animate-fade-in text-left">
                                    <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                        <h2 className="text-lg font-extrabold uppercase text-left">Fluxo Financeiro</h2>
                                        <button onClick={() => openModal('finance')} className="bg-amber-600 text-white px-5 py-2.5 rounded-xl text-xs font-extrabold shadow-lg">LANÇAMENTO</button>
                                    </div>
                                    <Card className="p-0 overflow-x-auto shadow-md">
                                        <table className="w-full text-xs font-bold text-left">
                                            <thead className="bg-slate-50 text-slate-400 uppercase font-extrabold text-[10px] border-b text-left">
                                                <tr><th className="p-4">Data</th><th className="p-4">Descrição</th><th className="p-4 text-right">Valor</th><th className="p-4 text-center">Status</th><th className="p-4 text-center">Ações</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50 text-left">
                                                {filteredFinancial.map(f => (
                                                    <tr key={f.id} className="hover:bg-slate-50 text-left"><td className="p-4 text-left">{new Date(f.date).toLocaleDateString()}</td><td className="p-4 uppercase text-left">{f.description}</td><td className={`p-4 text-right font-black ${f.type === 'Receita' ? 'text-amber-600' : 'text-red-500'}`}>{f.type === 'Receita'?'+':'-'} {formatCurrency(f.value)}</td><td className="p-4 text-center"><span className="px-3 py-1 rounded-full text-[10px] uppercase bg-amber-100 text-amber-700">{f.status}</span></td><td className="p-4 text-center"><button onClick={() => deleteFromCloud('financial', f.id, setFinancial, financial)} className="text-red-300"><Icon name="trash" weight="bold" size={18}/></button></td></tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </Card>
                                </div>
                            )}

                            {activeTab === 'config' && (
                                <div className="space-y-6 animate-fade-in max-w-4xl mx-auto text-left">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                                        <Card className="p-6 shadow-lg border-t-4 border-t-[#002147] text-left">
                                            <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-3 uppercase tracking-tighter"><Icon name="user-circle" className="text-amber-600"/> Dados Mestre</h3>
                                            <form onSubmit={handleSaveConfig} className="space-y-4 text-left">
                                                <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Nome da Administração</label><input className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-amber-600 outline-none font-bold text-slate-700 text-sm text-left" value={userData.name} onChange={e => setUserData({...userData, name: e.target.value})} /></div>
                                                <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">E-mail Principal</label><input type="email" className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-amber-600 outline-none font-bold text-slate-700 text-sm text-left" value={userData.email} onChange={e => setUserData({...userData, email: e.target.value})} /></div>
                                                <div className="text-left"><label className="text-[10px] font-black text-amber-600 uppercase block mb-1 text-left">Dia de Repasse da Imobiliária (Alarme)</label><input type="number" min="1" max="31" className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-amber-600 outline-none font-bold text-slate-700 text-sm text-left" value={userData.repasse_day} onChange={e => setUserData({...userData, repasse_day: e.target.value})} /></div>
                                                <button type="submit" className="w-full bg-[#002147] text-amber-50 font-black py-3 rounded-xl transition-all shadow-xl uppercase tracking-widest text-[10px] text-center">SALVAR DADOS MASTER</button>
                                            </form>
                                        </Card>
                                        <Card className="p-6 shadow-lg border-t-4 border-t-amber-600 text-left">
                                            <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-3 uppercase tracking-tighter"><Icon name="lock-key" className="text-amber-600"/> Alterar Senha Master</h3>
                                            <form onSubmit={handleChangePassword} className="space-y-4 text-left">
                                                <input type="password" required className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-amber-600 outline-none font-bold text-slate-700 text-sm text-left" placeholder="Senha Atual" value={configPasswordForm.current} onChange={e => setConfigPasswordForm({...configPasswordForm, current: e.target.value})} />
                                                <input type="password" required className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-amber-600 outline-none font-bold text-slate-700 text-sm text-left" placeholder="Nova Senha Master" value={configPasswordForm.newPass} onChange={e => setConfigPasswordForm({...configPasswordForm, newPass: e.target.value})} />
                                                <input type="password" required className="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-amber-600 outline-none font-bold text-slate-700 text-sm text-left" placeholder="Confirmar Nova Senha" value={configPasswordForm.confirm} onChange={e => setConfigPasswordForm({...configPasswordForm, confirm: e.target.value})} />
                                                <button type="submit" className="w-full bg-amber-600 hover:bg-[#002147] text-white font-black py-3 rounded-xl transition-all uppercase tracking-widest text-[10px] shadow-xl text-center">CONFIRMAR NOVA CREDENCIAL</button>
                                            </form>
                                        </Card>
                                    </div>
                                </div>
                            )}
                        </div>
                        <footer className="bg-white border-t border-slate-200 py-3 text-center text-[10px] text-slate-400 font-bold uppercase tracking-widest no-print shrink-0">
                            © 2026 SoftGestão. Propriedade de Adriana Mendes da Cruz Sousa. Auditoria Master de Patrimônio.
                        </footer>
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-[#002147]/80 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in text-left">
                            <div className={`bg-white rounded-[2rem] shadow-2xl w-full ${['contract_view', 'report_performance', 'report_docs', 'report_finance', 'report_tenants'].includes(modalType) ? 'max-w-7xl' : 'max-w-md'} overflow-hidden border-t-8 border-amber-600 flex flex-col max-h-[90vh]`}>
                                <div className="bg-white p-5 flex justify-between items-center border-b border-slate-100 shrink-0 text-left">
                                    <h3 className="font-extrabold text-lg uppercase tracking-tighter text-black text-left">Gestão de Auditoria Master</h3>
                                    <button onClick={() => setIsModalOpen(false)} className="bg-slate-100 p-2 rounded-lg text-slate-400 hover:text-amber-600 transition-colors"><Icon name="x" weight="bold" size={20}/></button>
                                </div>

                                <div className="flex-1 overflow-y-auto text-left">
                                    {modalType === 'contract_view' && editingItem ? (
                                        <div className="flex flex-col h-[70vh] bg-slate-100 text-left">
                                            <div className="bg-white px-6 py-3 border-b flex justify-between items-center shadow-sm shrink-0 text-left">
                                                <h3 className="font-bold flex items-center gap-2 text-left"><Icon name="file-pdf" className="text-red-600"/> {editingItem.fileName || 'Contrato'}</h3>
                                                <div className="flex items-center gap-4 text-left">
                                                    <button onClick={() => setPdfScale(s => s + 0.2)} className="bg-slate-100 p-2 rounded-lg hover:bg-slate-200"><Icon name="plus" size={16}/></button>
                                                    <span className="text-xs font-bold">{Math.round(pdfScale * 100)}%</span>
                                                    <button onClick={() => setPdfScale(s => Math.max(0.5, s - 0.2))} className="bg-slate-100 p-2 rounded-lg hover:bg-slate-200"><Icon name="minus" size={16}/></button>
                                                </div>
                                            </div>
                                            <div className="flex-1 overflow-auto p-8 flex justify-center text-left"><canvas id="pdf-canvas" className="bg-white shadow-2xl"></canvas></div>
                                        </div>
                                    ) : (
                                        <form onSubmit={saveItem} className="p-6 space-y-5 font-semibold text-left">
                                            {modalType === 'property' && (
                                                <div className="text-left space-y-5">
                                                    <div><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Apelido do Imóvel</label><input required className="w-full p-3 border border-slate-200 rounded-xl outline-none font-bold text-left" value={propertyForm.nickname} onChange={e => setPropertyForm({...propertyForm, nickname: e.target.value})} /></div>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div>
                                                            <label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Status de Ocupação</label>
                                                            <select className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={propertyForm.status} onChange={e => setPropertyForm({...propertyForm, status: e.target.value})}>
                                                                <option value="Vago">Vago</option><option value="Alugado">Alugado</option><option value="Em Reforma">Em Reforma</option><option value="Invadido">Invadido</option><option value="Em Negociação">Em Negociação</option>
                                                            </select>
                                                        </div>
                                                        <div><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Aluguel Pretendido (R$)</label><input type="number" required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={propertyForm.base_rent} onChange={e => setPropertyForm({...propertyForm, base_rent: e.target.value})} /></div>
                                                    </div>
                                                    
                                                    <div className="bg-red-50 p-4 rounded-xl border border-red-100 text-left">
                                                        <p className="text-[10px] font-black text-red-500 uppercase mb-3 text-left">Custos de Vacância (Auditoria de Perda)</p>
                                                        <div className="grid grid-cols-3 gap-3 mb-3">
                                                            <div><label className="text-[8px] font-black text-slate-400 uppercase block mb-1">Condomínio</label><input type="number" className="w-full p-2 border border-slate-200 rounded-lg text-xs" value={propertyForm.monthly_condo_cost} onChange={e=>setPropertyForm({...propertyForm, monthly_condo_cost:e.target.value})} placeholder="R$ 000" /></div>
                                                            <div><label className="text-[8px] font-black text-slate-400 uppercase block mb-1">IPTU Mensal</label><input type="number" className="w-full p-2 border border-slate-200 rounded-lg text-xs" value={propertyForm.monthly_iptu_cost} onChange={e=>setPropertyForm({...propertyForm, monthly_iptu_cost:e.target.value})} placeholder="R$ 000" /></div>
                                                            <div><label className="text-[8px] font-black text-slate-400 uppercase block mb-1">Manut. Est.</label><input type="number" className="w-full p-2 border border-slate-200 rounded-lg text-xs" value={propertyForm.monthly_maintenance_avg} onChange={e=>setPropertyForm({...propertyForm, monthly_maintenance_avg:e.target.value})} placeholder="R$ 000" /></div>
                                                        </div>
                                                        <div>
                                                            <label className="text-[9px] font-black text-red-600 uppercase block mb-1">Data da Desocupação (Para Alarme de 30 dias)</label>
                                                            <input type="date" className="w-full p-2 border border-red-200 rounded-lg text-xs font-bold" value={propertyForm.vacant_since} onChange={e=>setPropertyForm({...propertyForm, vacant_since:e.target.value})} />
                                                        </div>
                                                    </div>

                                                    <div><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Endereço Completo</label><input required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={propertyForm.address} onChange={e => setPropertyForm({...propertyForm, address: e.target.value})} placeholder="Rua, Número, Bairro, Cidade - UF" /></div>
                                                    
                                                    <div className="bg-slate-50 p-4 rounded-xl border text-left">
                                                        <p className="text-[10px] font-black text-slate-400 uppercase mb-3 text-left">Auditoria Documental</p>
                                                        <div className="flex gap-4 text-left"><label className="flex items-center gap-2 cursor-pointer text-left"><input type="checkbox" className="w-4 h-4 accent-[#002147]" checked={propertyForm.doc_registration} onChange={e=>setPropertyForm({...propertyForm, doc_registration:e.target.checked})} /> Matrícula</label><label className="flex items-center gap-2 cursor-pointer text-left"><input type="checkbox" className="w-4 h-4 accent-[#002147]" checked={propertyForm.doc_deed} onChange={e=>setPropertyForm({...propertyForm, doc_deed:e.target.checked})} /> Escritura</label><label className="flex items-center gap-2 cursor-pointer text-left"><input type="checkbox" className="w-4 h-4 accent-[#002147]" checked={propertyForm.doc_iptu} onChange={e=>setPropertyForm({...propertyForm, doc_iptu:e.target.checked})} /> IPTU</label></div>
                                                    </div>
                                                </div>
                                            )}

                                            {modalType === 'tenant' && (
                                                <div className="text-left space-y-5">
                                                    <div><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Nome Completo</label><input required className="w-full p-3 border border-slate-200 rounded-xl outline-none font-bold text-left" value={tenantForm.name} onChange={e => setTenantForm({...tenantForm, name: e.target.value})} /></div>
                                                    <div className="grid grid-cols-2 gap-4 text-left">
                                                        <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">CPF / NIF</label><input required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={tenantForm.cpf} onChange={e => setTenantForm({...tenantForm, cpf: maskCPF(e.target.value)})} /></div>
                                                        <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Telefone</label><input required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={tenantForm.phone} onChange={e => setTenantForm({...tenantForm, phone: maskPhone(e.target.value)})} /></div>
                                                    </div>
                                                    <div><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">E-mail</label><input type="email" className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={tenantForm.email} onChange={e => setTenantForm({...tenantForm, email: e.target.value})} /></div>
                                                    <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 text-left"><input type="checkbox" className="w-5 h-5 accent-[#002147]" checked={tenantForm.documents_checked} onChange={e => setTenantForm({...tenantForm, documents_checked: e.target.checked})} /><span className="text-xs font-bold text-slate-500 uppercase tracking-wide">Documentação Auditada?</span></div>
                                                </div>
                                            )}

                                            {modalType === 'contract' && (
                                                <div className="text-left space-y-5">
                                                    <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Vincular Imóvel</label><select required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={contractForm.propertyId} onChange={e => setContractForm({...contractForm, propertyId: e.target.value})}><option value="">Selecione...</option>{properties.map(p=><option key={p.id} value={p.id}>{p.nickname}</option>)}</select></div>
                                                    <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Vincular Locatário</label><select required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={contractForm.tenantId} onChange={e => setContractForm({...contractForm, tenantId: e.target.value})}><option value="">Selecione...</option>{tenants.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</select></div>
                                                    
                                                    <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
                                                        <p className="text-[10px] font-black text-amber-600 uppercase mb-3">Laudos de Vistoria (Proteção de Patrimônio)</p>
                                                        <div className="space-y-3">
                                                            <div className="p-2 border-2 border-dashed border-amber-200 rounded-lg relative hover:bg-white transition-colors">
                                                                <p className="text-[9px] font-bold text-amber-500 text-center uppercase">{contractForm.inspection_entry_name || "Anexar Laudo de Entrada (PDF/Fotos)"}</p>
                                                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => { const f = e.target.files[0]; const r = new FileReader(); r.onloadend = () => setContractForm({...contractForm, inspection_entry_name: f.name, inspection_entry_data: r.result}); if(f) r.readAsDataURL(f); }} />
                                                            </div>
                                                            <div className="p-2 border-2 border-dashed border-slate-200 rounded-lg relative hover:bg-white transition-colors">
                                                                <p className="text-[9px] font-bold text-slate-400 text-center uppercase">{contractForm.inspection_exit_name || "Anexar Laudo de Saída (Finalização)"}</p>
                                                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => { const f = e.target.files[0]; const r = new FileReader(); r.onloadend = () => setContractForm({...contractForm, inspection_exit_name: f.name, inspection_exit_data: r.result}); if(f) r.readAsDataURL(f); }} />
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className="grid grid-cols-2 gap-4 text-left">
                                                        <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Valor do Aluguel (R$)</label><input type="number" required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={contractForm.rent_value} onChange={e => setContractForm({...contractForm, rent_value: e.target.value})} /></div>
                                                        <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Data Fim Contrato (Alarme)</label><input type="date" required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={contractForm.end_date} onChange={e => setContractForm({...contractForm, end_date: e.target.value})} /></div>
                                                    </div>
                                                    <div className="p-4 border-2 border-dashed border-slate-200 rounded-xl text-center relative hover:bg-slate-50 transition-colors text-left"><Icon name="cloud-arrow-up" size={24} className="mx-auto mb-1 text-[#002147]"/><p className="text-[10px] font-black uppercase text-slate-400 text-center">{contractForm.fileName || "Anexar Contrato PDF (Auditoria Master)"}</p><input type="file" accept="application/pdf" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => { const file = e.target.files[0]; const r = new FileReader(); r.onloadend = () => setContractForm({...contractForm, fileName: file.name, fileData: r.result}); if(file) r.readAsDataURL(file); }} /></div>
                                                </div>
                                            )}

                                            {modalType === 'finance' && (
                                                <div className="text-left space-y-5">
                                                    <div className="grid grid-cols-2 gap-4 text-left">
                                                        <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Modalidade</label><select className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={financeForm.type} onChange={e => setFinanceForm({...financeForm, type: e.target.value})}><option value="Receita">Receita (+)</option><option value="Despesa">Despesa (-)</option></select></div>
                                                        <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase block mb-1 text-left">Data</label><input type="date" className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" value={financeForm.date} onChange={e => setFinanceForm({...financeForm, date: e.target.value})} /></div>
                                                    </div>
                                                    <div className="text-left"><input required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" placeholder="Descrição da Transação Master" value={financeForm.description} onChange={e => setFinanceForm({...financeForm, description: e.target.value})} /></div>
                                                    <div className="text-left"><input type="number" required className="w-full p-3 border border-slate-200 rounded-xl font-bold text-left" placeholder="Valor Transacionado (R$)" value={financeForm.value} onChange={e => setFinanceForm({...financeForm, value: e.target.value})} /></div>
                                                </div>
                                            )}

                                            <div className="pt-5 flex justify-end gap-3 border-t border-slate-100 shrink-0 text-left">
                                                <button type="button" onClick={() => setIsModalOpen(false)} className="px-5 py-3 text-slate-400 font-bold uppercase text-[10px] hover:bg-slate-50 rounded-xl transition-all">Cancelar</button>
                                                <button type="submit" className="px-8 py-3 bg-[#002147] text-amber-500 font-black rounded-xl shadow-xl transition-all text-[10px] uppercase tracking-widest hover:bg-amber-600 hover:text-white flex items-center gap-2"><Icon name="check" weight="bold"/> SALVAR MASTER</button>
                                            </div>
                                        </form>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
